#!/bin/bash

_platform_mattlaptop_match() {

  echo
}


_platform_mattlaptop_setup() {

  echo
}


_platform_perlmutter_match() {

  echo
}


_platform_perlmutter_setup() {

  module load cmake
  module unload darshan/3.1.4
  module load nvidia
}


_scenario_gpu_trial1_mattlaptop_build() {

  echo
}


_scenario_gpu_trial1_mattlaptop_run() {

  echo
}


_scenario_gpu_trial1_perlmutter_build() {

  rm -rf ./build

  mkdir ./build && cd $_

  cmake \
      -DCMAKE_BUILD_TYPE="Debug" \
      -DCMAKE_Fortran_FLAGS="-fast -mp=gpu -gpu=cc80 -Mfree" \
      -DCMAKE_Fortran_FLAGS_DEBUG="-Minfo=all" \
    ..

  LAUNCHKIT_RUNTIME_PATH_EXE="$(pwd -P)/"

  cd - >/dev/null
}


_scenario_gpu_trial1_perlmutter_run() {

  local readonly binexe="$1"

  cd $(mktemp -d) || return 1
  mkdir .launchkit && cd $_

  launchkit_dugout_dir="$(pwd -P)"

  cat > ./slurm_job.sh <<-__EOF__

	#!/bin/bash

	#SBATCH -A ntrain1
	#SBATCH -C gpu
	#SBATCH -q regular
	#SBATCH -t 1:00:00
	#SBATCH -N 1
	#SBATCH --ntasks-per-node=1
	#SBATCH -c 128
	#SBATCH --gpus-per-task=1
	#SBATCH --gpu-bind=none

	export SLURM_CPU_BIND="cores"
	srun nsys profile -o thinger --stats=true $LAUNCHKIT_RUNTIME_PATH_EXE

	__EOF__

  echo "."; echo "."; cat ./slurm_job.sh
  echo "."; echo "."

  cd - >/dev/null

  # cleanup temp dir
  [[ ${launchkit_dugout_dir%/*} =~ .+/tmp\..+ ]] && rm -rf ${launchkit_dugout_dir%/*}
}



__setup() {

  _platform_perlmutter_setup
}


__build_then_run() {

  _scenario_gpu_trial1_perlmutter_build
  _scenario_gpu_trial1_perlmutter_run
}


LAUNCHKIT_RUNTIME_PATH_EXE=""


#__setup
__build
__run


